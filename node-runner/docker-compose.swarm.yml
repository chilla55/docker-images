version: '3.8'

services:
  node-runner:
    image: ghcr.io/chilla55/node-runner:latest # build and push your own tag/registry
    environment:
      ENTRY_COMMAND: "npm i classic-level && node main.js --dataPath=/workspace/data"          # required: what to run
      ENTRY_INSTALL: "1"                       # run npm install/ci when package.json present
      ENTRY_BUILD: "0"                         # set to 1 to run npm run build when lockfile exists
      APP_DIR: "/workspace/app"                # where code is extracted/mounted
      APP_PORT: "30000"                        # port your app listens on
      SERVICE_NAME: "foundryvtt"                  # registry service name
      DOMAINS: "foundry.chilla55.de"           # comma-separated domains
      ROUTE_PATH: "/"                         # path prefix
      HEALTH_PATH: "/"                        # health endpoint for registry checks
      REGISTRY_HOST: "tasks.go-proxy_proxy"   # go-proxy registry service in Swarm
      REGISTRY_PORT: "81"                     # registry TCP port
      ENABLE_REGISTRY: "true"                 # set false to skip registration
      ENABLE_WEBSOCKET: "true"               # allow WS upgrades
      BACKEND_HTTP2: "false"                 # force HTTP/1.1 upstream for WS compatibility
      PRESERVE_HOST: "true"                  # keep original Host header
      ENABLE_SOCKETIO_ROUTE: "true"          # register dedicated /socket.io/ route
      SOCKETIO_PATH: "/socket.io/"          # path used for Socket.IO/ws
      WAIT_FOR_PORT: "true"                   # wait for APP_PORT before registering
      PORT_WAIT_TIMEOUT: "30s"
      ZIP_PATH: "/workspace/app.zip"          # host-mounted zip file (optional)
      ZIP_STRIP_COMPONENTS: "1"                # drop leading dirs inside the zip
      ZIP_CLEAN: "1"                          # wipe APP_DIR before extract
    volumes:
      - nodeapp-app:/workspace/app               # persistent app code
      - nodeapp-data:/workspace/data             # user data (your app should write here)
      - /mnt/storagebox/nodezip/foundryvtt_13.350.zip:/workspace/app.zip:rslave # mount your zip bundle
    networks:
      - web-net
    deploy:
      mode: replicated
      replicas: 1
      endpoint_mode: dnsrr
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 300s
      update_config:
        parallelism: 1
        delay: 5s
        order: start-first
      placement:
        constraints:
          - node.labels.web.node == web

networks:
  web-net:
    external: true

volumes:
  nodeapp-app:
    driver: local
  nodeapp-data:
    driver: local
