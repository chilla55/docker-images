# ============================================================================
# Supervisord Configuration for Pterodactyl Panel
# ============================================================================
# Manages: PHP-FPM, Caddy, Queue Worker, Scheduler
# ============================================================================

[supervisord]
nodaemon=true
user=root
loglevel=info
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/ptero

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

# ──────────────────────────────────────────────────────────────────────────
# PHP-FPM (Priority 1 - Must start first)
# ──────────────────────────────────────────────────────────────────────────
[program:php-fpm]
command=/usr/sbin/php-fpm83 -F -R
directory=/var/www/pterodactyl
autostart=true
autorestart=true
priority=1
startretries=10
startsecs=5
stopwaitsecs=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
redirect_stderr=false

# ──────────────────────────────────────────────────────────────────────────
# Caddy Web Server (Priority 2 - Start after PHP-FPM)
# ──────────────────────────────────────────────────────────────────────────
[program:caddy]
command=/usr/bin/caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
directory=/var/www/pterodactyl/public
autostart=true
autorestart=true
priority=2
startretries=10
startsecs=5
stopwaitsecs=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
redirect_stderr=false

# ──────────────────────────────────────────────────────────────────────────
# Laravel Queue Worker (Priority 5)
# ──────────────────────────────────────────────────────────────────────────
# Matches official Pterodactyl systemd service with added protections:
# - --timeout=60: Prevent jobs from hanging indefinitely (especially mail)
# - --max-time=1800: Restart worker every 30 minutes to recover from stuck states
# ──────────────────────────────────────────────────────────────────────────
[program:queue-worker]
command=/usr/bin/php /var/www/pterodactyl/artisan queue:work --queue=high,standard,low --sleep=3 --tries=3 --timeout=60 --max-time=1800
directory=/var/www/pterodactyl
autostart=true
autorestart=true
priority=5
startretries=0
startsecs=5
stopwaitsecs=60
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
redirect_stderr=false

# ──────────────────────────────────────────────────────────────────────────
# Laravel Scheduler (Priority 10)
# ──────────────────────────────────────────────────────────────────────────
[program:scheduler]
command=/bin/bash -c "while true; do /usr/bin/php /var/www/pterodactyl/artisan schedule:run --verbose --no-interaction >> /proc/self/fd/1 2>&1; sleep 60; done"
directory=/var/www/pterodactyl
autostart=true
autorestart=true
priority=10
startretries=10
startsecs=5
stopwaitsecs=10
stopasgroup=true
killasgroup=true
user=www-data
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
redirect_stderr=false

# ──────────────────────────────────────────────────────────────────────────
# Event Listener: Log rotation prevention (already handled by Docker)
# ──────────────────────────────────────────────────────────────────────────
[eventlistener:stdout]
command=/bin/cat
events=PROCESS_LOG
buffer_size=100
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

