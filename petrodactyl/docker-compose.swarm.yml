# ============================================================================
# Docker Swarm Stack for Pterodactyl Panel
# ============================================================================
# Deploy: docker stack deploy -c docker-compose.swarm.yml pterodactyl
# ============================================================================

version: "3.8"

# ──────────────────────────────────────────────────────────────────────────
# Networks
# ──────────────────────────────────────────────────────────────────────────
networks:
  web-net:
    external: true
  
  mariadb-net:
    external: true
  
  redis-net:
    external: true
  
  pterodactyl-net:
    driver: overlay
    attachable: true

# ──────────────────────────────────────────────────────────────────────────
# Secrets
# ──────────────────────────────────────────────────────────────────────────
secrets:
  panel_app_key:
    external: true
    name: pterodactyl_app_key
  
  panel_db_password:
    external: true
    name: pterodactyl_db_password
  
  panel_mail_password:
    external: true
    name: vaultwarden_smtp_password

# ──────────────────────────────────────────────────────────────────────────
# Configs
# ──────────────────────────────────────────────────────────────────────────
configs:
  caddy_config:
    file: ./Caddyfile
  
  php_fpm_pool:
    file: ./php-fpm-pool.conf
  
  php_ini_custom:
    file: ./php-custom.ini

# ──────────────────────────────────────────────────────────────────────────
# Volumes
# ──────────────────────────────────────────────────────────────────────────
volumes:
  pterodactyl_app:
    driver: local

# ──────────────────────────────────────────────────────────────────────────
# Shared Environment Configuration (YAML anchor)
# ──────────────────────────────────────────────────────────────────────────
x-pterodactyl-env: &pterodactyl-env
  APP_ENV: production
  APP_DEBUG: "false"
  APP_URL: https://gpanel.chilla55.de
  APP_TIMEZONE: Europe/Berlin
  APP_LOCALE: en
  APP_KEY_FILE: /run/secrets/panel_app_key
  
  CACHE_DRIVER: redis
  SESSION_DRIVER: redis
  QUEUE_CONNECTION: redis
  
  DB_CONNECTION: mysql
  DB_HOST: mariadb
  DB_PORT: "3306"
  DB_DATABASE: panel
  DB_USERNAME: pterodactyl
  DB_PASSWORD_FILE: /run/secrets/panel_db_password
  
  REDIS_HOST: redis
  REDIS_PORT: "6379"
  REDIS_PASSWORD: ""
  
  MAIL_MAILER: smtp
  MAIL_HOST: smtp.example.com
  MAIL_PORT: "25"
  MAIL_USERNAME: ""
  MAIL_PASSWORD_FILE: /run/secrets/panel_mail_password
  MAIL_ENCRYPTION: tls
  MAIL_FROM_ADDRESS: no-reply@chilla55.de
  MAIL_FROM_NAME: "Pterodactyl Panel"
  
  HASHIDS_SALT: aMxyVI3NeaVOCVajWfyz
  HASHIDS_LENGTH: "8"
  APP_SERVICE_AUTHOR: a.g0201@gmx.de
  PTERODACTYL_TELEMETRY_ENABLED: "false"
  SESSION_SECURE_COOKIE: "true"
  TRUSTED_PROXIES: "*"
  
  RUN_MIGRATIONS_ON_START: "true"
  RUN_SEED_ON_START: "false"

# ──────────────────────────────────────────────────────────────────────────
# Services
# ──────────────────────────────────────────────────────────────────────────
services:
  # ────────────────────────────────────────────────────────────────────────
  # PHP-FPM Service (FastCGI server on port 9000)
  # ────────────────────────────────────────────────────────────────────────
  php-fpm:
    image: ghcr.io/chilla55/pterodactyl-panel:latest
    hostname: pterodactyl-php-fpm
    
    command: ["php-fpm"]
    
    networks:
      - pterodactyl-net
      - mariadb-net
      - redis-net
    
    environment:
      <<: *pterodactyl-env
      APP_LOCALE: en
      APP_KEY_FILE: /run/secrets/panel_app_key
      
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      
      DB_CONNECTION: mysql
      DB_HOST: mariadb
      DB_PORT: "3306"
      DB_DATABASE: panel
      DB_USERNAME: pterodactyl
      DB_PASSWORD_FILE: /run/secrets/panel_db_password
      
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ""
      
      MAIL_MAILER: smtp
      MAIL_HOST: smtp.example.com
      MAIL_PORT: "25"
      MAIL_USERNAME: ""
      MAIL_PASSWORD_FILE: /run/secrets/panel_mail_password
      MAIL_ENCRYPTION: tls
      MAIL_FROM_ADDRESS: no-reply@chilla55.de
      MAIL_FROM_NAME: "Pterodactyl Panel"
      
      HASHIDS_SALT: aMxyVI3NeaVOCVajWfyz
      HASHIDS_LENGTH: "8"
      APP_SERVICE_AUTHOR: a.g0201@gmx.de
      PTERODACTYL_TELEMETRY_ENABLED: "false"
      SESSION_SECURE_COOKIE: "true"
      TRUSTED_PROXIES: "*"
      
      RUN_MIGRATIONS_ON_START: "true"
      RUN_SEED_ON_START: "false"
    
    secrets:
      - panel_app_key
      - panel_db_password
      - panel_mail_password
    
    configs:
      - source: php_fpm_pool
        target: /etc/php83/php-fpm.d/pterodactyl.conf
        mode: 0444
      - source: php_ini_custom
        target: /etc/php83/conf.d/99-custom.ini
        mode: 0444
    
    volumes:
      - pterodactyl_app:/var/www/pterodactyl
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.web.node == web
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 300s
      labels:
        - "com.pterodactyl.service=php-fpm"
    
    stop_grace_period: 10s

  # ────────────────────────────────────────────────────────────────────────
  # Caddy HTTP Server (port 80, proxies to php-fpm:9000)
  # ────────────────────────────────────────────────────────────────────────
  caddy:
    image: ghcr.io/chilla55/pterodactyl-panel:latest
    hostname: pterodactyl-caddy
    
    command: ["caddy"]
    
    networks:
      - pterodactyl-net
      - web-net
    
    volumes:
      - pterodactyl_app:/var/www/pterodactyl
    
    configs:
      - source: caddy_config
        target: /etc/caddy/Caddyfile
        mode: 0444
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.web.node == web
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 300s
      labels:
        - "com.pterodactyl.service=caddy"
    
    stop_grace_period: 10s
    
    environment:
      # go-proxy registry
      REGISTRY_HOST: proxy
      REGISTRY_PORT: "81"
      DOMAINS: gpanel.chilla55.de
      ROUTE_PATH: /
      BACKEND_HOST: pterodactyl-caddy
      PORT: "80"

  # ────────────────────────────────────────────────────────────────────────
  # Queue Worker Service
  # ────────────────────────────────────────────────────────────────────────
  queue:
    image: ghcr.io/chilla55/pterodactyl-panel:latest
    hostname: pterodactyl-queue
    
    command: ["queue"]
    
    networks:
      - mariadb-net
      - redis-net
    
    environment:
      <<: *pterodactyl-env
    
    secrets:
      - panel_app_key
      - panel_db_password
      - panel_mail_password
    
    volumes:
      - pterodactyl_app:/var/www/pterodactyl
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.web.node == web
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 300s
      labels:
        - "com.pterodactyl.service=queue"
    
    stop_grace_period: 30s

  # ────────────────────────────────────────────────────────────────────────
  # Cron/Scheduler Service
  # ────────────────────────────────────────────────────────────────────────
  cron:
    image: ghcr.io/chilla55/pterodactyl-panel:latest
    hostname: pterodactyl-cron
    
    command: ["cron"]
    
    networks:
      - mariadb-net
      - redis-net
    
    environment:
      <<: *pterodactyl-env
    
    secrets:
      - panel_app_key
      - panel_db_password
      - panel_mail_password
    
    volumes:
      - pterodactyl_app:/var/www/pterodactyl
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.web.node == web
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.05'
          memory: 64M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 300s
      labels:
        - "com.pterodactyl.service=cron"
    
    stop_grace_period: 10s
