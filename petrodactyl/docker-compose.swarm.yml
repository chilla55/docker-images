# ============================================================================
# Docker Swarm Stack for Pterodactyl Panel
# ============================================================================
# Deploy: docker stack deploy -c docker-compose.swarm.yml pterodactyl
# ============================================================================

version: "3.8"

# ──────────────────────────────────────────────────────────────────────────
# Networks
# ──────────────────────────────────────────────────────────────────────────
networks:
  proxy:
    external: true
    name: proxy  # External nginx reverse proxy network
  
  database:
    external: true
    name: database  # External MariaDB network
  
  cache:
    external: true
    name: cache  # External Redis network

# ──────────────────────────────────────────────────────────────────────────
# Secrets
# ──────────────────────────────────────────────────────────────────────────
secrets:
  panel_app_key:
    external: true
    name: pterodactyl_app_key
  
  panel_db_password:
    external: true
    name: pterodactyl_db_password
  
  panel_redis_password:
    external: true
    name: pterodactyl_redis_password
  
  panel_mail_password:
    external: true
    name: pterodactyl_mail_password

# ──────────────────────────────────────────────────────────────────────────
# Services
# ──────────────────────────────────────────────────────────────────────────
services:
  # ────────────────────────────────────────────────────────────────────────
  # Pterodactyl Panel (All-in-One Container)
  # ────────────────────────────────────────────────────────────────────────
  panel:
    image: ghcr.io/chilla55/pterodactyl-panel:latest
    
    # Build configuration (for local development)
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     PANEL_VERSION: "$(cat VERSION)"
    
    hostname: pterodactyl-panel
    
    networks:
      - proxy      # For nginx reverse proxy
      - database   # For MariaDB access
      - cache      # For Redis access
    
    environment:
      # ──────────────────────────────────────────────────────────────────
      # Application Settings
      # ──────────────────────────────────────────────────────────────────
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: https://panel.example.com
      APP_TIMEZONE: Europe/Berlin
      APP_LOCALE: en
      
      # Secret file paths
      APP_KEY_FILE: /run/secrets/panel_app_key
      
      # ──────────────────────────────────────────────────────────────────
      # Cache & Session
      # ──────────────────────────────────────────────────────────────────
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      
      # ──────────────────────────────────────────────────────────────────
      # Database Settings
      # ──────────────────────────────────────────────────────────────────
      DB_CONNECTION: mysql
      DB_HOST: mariadb
      DB_PORT: "3306"
      DB_DATABASE: panel
      DB_USERNAME: paneluser
      DB_PASSWORD_FILE: /run/secrets/panel_db_password
      
      # ──────────────────────────────────────────────────────────────────
      # Redis Settings
      # ──────────────────────────────────────────────────────────────────
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_PASSWORD_FILE: /run/secrets/panel_redis_password
      
      # ──────────────────────────────────────────────────────────────────
      # Mail Settings
      # ──────────────────────────────────────────────────────────────────
      MAIL_MAILER: smtp
      MAIL_HOST: smtp.example.com
      MAIL_PORT: "587"
      MAIL_USERNAME: noreply@example.com
      MAIL_PASSWORD_FILE: /run/secrets/panel_mail_password
      MAIL_ENCRYPTION: tls
      MAIL_FROM_ADDRESS: noreply@example.com
      MAIL_FROM_NAME: "Pterodactyl Panel"
      
      # ──────────────────────────────────────────────────────────────────
      # Hashids (for obfuscating IDs)
      # ──────────────────────────────────────────────────────────────────
      HASHIDS_SALT: random-salt-change-this
      HASHIDS_LENGTH: "8"
      
      # ──────────────────────────────────────────────────────────────────
      # Trusted Proxies (nginx reverse proxy)
      # ──────────────────────────────────────────────────────────────────
      TRUSTED_PROXIES: "*"
      
      # ──────────────────────────────────────────────────────────────────
      # Runtime Behavior
      # ──────────────────────────────────────────────────────────────────
      RUN_MIGRATIONS_ON_START: "true"   # Always run migrations on startup
      RUN_SEED_ON_START: "false"        # Set to "true" only for first deployment
    
    secrets:
      - panel_app_key
      - panel_db_password
      - panel_redis_password
      - panel_mail_password
    
    deploy:
      mode: replicated
      replicas: 1
      
      # Placement constraints (optional - adjust for your needs)
      placement:
        constraints:
          - node.role == worker
        preferences:
          - spread: node.labels.zone
      
      # Resource limits
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      
      # Update configuration
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 30s
        order: start-first
      
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        monitor: 10s
        order: stop-first
      
      # Restart policy
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
      
      # Labels for Traefik/nginx integration (adjust as needed)
      labels:
        - "com.pterodactyl.service=panel"
    
    healthcheck:
      test: ["/healthcheck.sh"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    
    stop_grace_period: 30s
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,version"
