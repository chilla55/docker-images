version: '3.8'

services:
  postgresql-primary:
    image: ghcr.io/chilla55/postgresql-replication:${VERSION:-latest}
    hostname: postgresql-primary
    environment:
      POSTGRES_PASSWORD_FILE: "/run/secrets/postgres_password"
      POSTGRES_DB: ${POSTGRES_DB:-app_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      REPLICATION_MODE: "primary"
      REPLICATION_USER: "replicator"
      REPLICATION_PASSWORD_FILE: "/run/secrets/postgres_replication_password"
      ENABLE_CONNECTIVITY_MONITOR: "true"
      SECONDARY_HOST: "postgresql-secondary"
      CHECK_INTERVAL: "5"
    volumes:
      - postgresql-primary-data:/var/lib/postgresql/data
      - postgresql-primary-logs:/var/log/postgresql
    secrets:
      - postgres_password
      - postgres_replication_password
    networks:
      - postgres-net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.postgresql.node == srv1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  postgresql-secondary:
    image: ghcr.io/chilla55/postgresql-replication:${VERSION:-latest}
    hostname: postgresql-secondary
    environment:
      POSTGRES_PASSWORD_FILE: "/run/secrets/postgres_password"
      POSTGRES_DB: ${POSTGRES_DB:-app_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      REPLICATION_MODE: "replica"
      REPLICATION_USER: "replicator"
      REPLICATION_PASSWORD_FILE: "/run/secrets/postgres_replication_password"
      PRIMARY_HOST: "postgresql-primary"
      PRIMARY_PORT: "5432"
      ENABLE_CONNECTIVITY_MONITOR: "true"
      CHECK_INTERVAL: "5"
    volumes:
      - postgresql-secondary-data:/var/lib/postgresql/data
      - postgresql-secondary-logs:/var/log/postgresql
    secrets:
      - postgres_password
      - postgres_replication_password
    networks:
      - postgres-net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.postgresql.node == mail
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    depends_on:
      - postgresql-primary

  pgpool:
    image: ghcr.io/chilla55/pgpool-custom:${VERSION:-latest}
    hostname: pgpool
    environment:
      PGPOOL_BACKEND_NODES: "0:postgresql-primary:5432,1:postgresql-secondary:5432"
      PGPOOL_SR_CHECK_USER: "${REPLICATION_USER}"
      PGPOOL_SR_CHECK_PASSWORD_FILE: "/run/secrets/postgres_replication_password"
      PGPOOL_POSTGRES_USERNAME: "${POSTGRES_USER:-postgres}"
      PGPOOL_POSTGRES_PASSWORD_FILE: "/run/secrets/postgres_password"
      PGPOOL_ADMIN_USERNAME: "${PGPOOL_ADMIN_USER:-admin}"
      PGPOOL_ADMIN_PASSWORD_FILE: "/run/secrets/pgpool_admin_password"
      PGPOOL_ENABLE_LOAD_BALANCING: "yes"
      PGPOOL_AUTO_FAILBACK: "yes"
      PGPOOL_FAILOVER_ON_BACKEND_ERROR: "yes"
      PGPOOL_NUM_INIT_CHILDREN: "32"
      PGPOOL_MAX_POOL: "4"
    volumes:
      - pgpool-data:/bitnami/pgpool
    secrets:
      - postgres_password
      - postgres_replication_password
      - pgpool_admin_password
    networks:
      - postgres-net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.postgresql.node == srv2
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M
    depends_on:
      - postgresql-primary
      - postgresql-secondary

volumes:
  postgresql-primary-data:
    driver: local
  postgresql-primary-logs:
    driver: local
  postgresql-secondary-data:
    driver: local
  postgresql-secondary-logs:
    driver: local
  pgpool-data:
    driver: local

networks:
  postgres-net:
    external: true

secrets:
  postgres_password:
    external: true
    name: postgres_password
  postgres_replication_password:
    external: true
    name: postgres_replication_password
  pgpool_admin_password:
    external: true
    name: pgpool_admin_password
