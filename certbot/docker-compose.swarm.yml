# ============================================================================
# Docker Swarm Stack for Certbot with Hetzner Storage Box
# ============================================================================
# Deploy: docker stack deploy -c docker-compose.swarm.yml certbot
# ============================================================================

version: "3.8"

# ──────────────────────────────────────────────────────────────────────────
# Networks
# ──────────────────────────────────────────────────────────────────────────
networks:
  web-net:
    external: true

# ──────────────────────────────────────────────────────────────────────────
# Secrets
# ──────────────────────────────────────────────────────────────────────────
secrets:
  cloudflare_api_token:
    external: true
    name: cloudflare_api_token

# ──────────────────────────────────────────────────────────────────────────
# Volumes
# ──────────────────────────────────────────────────────────────────────────
# Note: No volumes needed - certificates stored directly on Storage Box mount

# ──────────────────────────────────────────────────────────────────────────
# Services
# ──────────────────────────────────────────────────────────────────────────
services:
  # ────────────────────────────────────────────────────────────────────────
  # Certbot with Cloudflare DNS and Storage Box Sync
  # ────────────────────────────────────────────────────────────────────────
  # Certbot with Cloudflare DNS and Storage Box CIFS Mount
  # ────────────────────────────────────────────────────────────────────────
  certbot:
    image: ghcr.io/chilla55/certbot-storagebox:latest
    
    # Build configuration (for local development)
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    
    hostname: certbot
    
    networks:
      - web-net
    
    environment:
      # ──────────────────────────────────────────────────────────────────
      # Certificate Configuration
      # ──────────────────────────────────────────────────────────────────
      CERT_EMAIL: admin@chilla55.de
      CERT_DOMAINS: chilla55.de,*.chilla55.de
      RENEW_INTERVAL: 12h  # Check for renewals every 12 hours
      CERTBOT_DRY_RUN: "false"   # Use Let's Encrypt staging / dry-run
      
      # ──────────────────────────────────────────────────────────────────
      # Cloudflare DNS Settings
      # ──────────────────────────────────────────────────────────────────
      CLOUDFLARE_CREDENTIALS_FILE: /run/secrets/cloudflare_api_token
      
      # ──────────────────────────────────────────────────────────────────
      # Debug Settings
      # ──────────────────────────────────────────────────────────────────
      DEBUG: "false"
    
    secrets:
      - cloudflare_api_token
    
    volumes:
      # Bind-mount host's Storage Box certs directory to container
      - /mnt/storagebox/certs:/etc/letsencrypt:rslave
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.certbot.node == srv2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 6h
      timeout: 30s
      retries: 3
      start_period: 1m
