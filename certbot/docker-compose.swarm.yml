# ============================================================================
# Docker Swarm Stack for Certbot with Hetzner Storage Box
# ============================================================================
# Deploy: docker stack deploy -c docker-compose.swarm.yml certbot
# ============================================================================

version: "3.8"

# ──────────────────────────────────────────────────────────────────────────
# Networks
# ──────────────────────────────────────────────────────────────────────────
networks:
  web-net:
    external: true

# ──────────────────────────────────────────────────────────────────────────
# Secrets
# ──────────────────────────────────────────────────────────────────────────
secrets:
  cloudflare_api_token:
    external: true
    name: cloudflare_api_token
  
  storagebox_password:
    external: true
    name: storagebox_password

# ──────────────────────────────────────────────────────────────────────────
# Volumes
# ──────────────────────────────────────────────────────────────────────────
# Note: No volumes needed - certificates stored directly on Storage Box mount

# ──────────────────────────────────────────────────────────────────────────
# Services
# ──────────────────────────────────────────────────────────────────────────
services:
  # ────────────────────────────────────────────────────────────────────────
  # Certbot with Cloudflare DNS and Storage Box Sync
  # ────────────────────────────────────────────────────────────────────────
  # Certbot with Cloudflare DNS and Storage Box CIFS Mount
  # ────────────────────────────────────────────────────────────────────────
  certbot:
    image: ghcr.io/chilla55/certbot-storagebox:latest
    
    # Build configuration (for local development)
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    
    hostname: certbot
    
    networks:
      - web-net
    
    # Required for CIFS mount (minimal capabilities, not privileged)
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    security_opt:
      - apparmor:unconfined
    
    environment:
      # ──────────────────────────────────────────────────────────────────
      # Certificate Configuration
      # ──────────────────────────────────────────────────────────────────
      CERT_EMAIL: admin@chilla55.de
      CERT_DOMAINS: chilla55.de,*.chilla55.de
      RENEW_INTERVAL: 12h  # Check for renewals every 12 hours
      
      # ──────────────────────────────────────────────────────────────────
      # Cloudflare DNS Settings
      # ──────────────────────────────────────────────────────────────────
      CLOUDFLARE_CREDENTIALS_FILE: /run/secrets/cloudflare_api_token
      
      # ──────────────────────────────────────────────────────────────────
      # Hetzner Storage Box Settings (SMB3 primary, SSHFS fallback)
      # ──────────────────────────────────────────────────────────────────
      STORAGE_BOX_ENABLED: "true"
      STORAGE_BOX_HOST: u515899.your-storagebox.de
      STORAGE_BOX_USER: u515899
      STORAGE_BOX_SSH_PORT: "23"
      STORAGE_BOX_PATH: /backup
      # Mount options for SMB3/CIFS
      STORAGE_BOX_MOUNT_OPTIONS: "vers=3.0,seal,nodfs,noserverino,nounix,uid=0,gid=1001,file_mode=0640,dir_mode=0750"
      CERTBOT_DRY_RUN: "true"   # Use Let's Encrypt staging / dry-run
      
      # ──────────────────────────────────────────────────────────────────
      # Debug Settings
      # ──────────────────────────────────────────────────────────────────
      DEBUG: "false"
    
    secrets:
      - cloudflare_api_token
      - storagebox_password
    
    # Note: /etc/letsencrypt is mounted from Storage Box via CIFS in entrypoint.sh
    # No Docker socket needed - nginx auto-reloads via certificate watcher
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.certbot.node == srv2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 6h
      timeout: 30s
      retries: 3
      start_period: 1m
