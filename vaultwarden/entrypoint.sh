#!/bin/bash
set -e

# Check if keys directory is mounted from host (at /data/keys)
if [ -d "/data/keys" ]; then
    echo "Storage Box keys directory mounted at /data/keys"
    
    # Create symlink from /data/rsa_key.pem to Storage Box location
    if [ ! -L "/data/rsa_key.pem" ]; then
        # If key exists in Storage Box, use it
        if [ -f "/data/keys/rsa_key.pem" ]; then
            echo "Using existing RSA key from Storage Box"
            ln -sf /data/keys/rsa_key.pem /data/rsa_key.pem
            ln -sf /data/keys/rsa_key.pub.pem /data/rsa_key.pub.pem
        else
            # Will be generated by Vaultwarden, then moved by post-start script
            echo "RSA key will be generated and moved to Storage Box"
            /usr/local/bin/post-start.sh &
        fi
    fi
fi

# Execute original Vaultwarden entrypoint
exec /start.sh "$@"
