version: '3.8'

services:
  mariadb-primary:
    image: ghcr.io/chilla55/mariadb-replication:${VERSION:-latest}
    hostname: mariadb-primary
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: ${MYSQL_DATABASE:-app_db}
      MYSQL_USER: ${MYSQL_USER:-app_user}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_user_password
      REPLICATION_MODE: "master"
      REPLICATION_USER: "replicator"
      REPLICATION_PASSWORD_FILE: /run/secrets/replication_password
      ENABLE_CONNECTIVITY_MONITOR: "true"
      ENABLE_AUTO_RECOVERY: "true"
      SECONDARY_HOST: "mariadb-secondary"
      MAXSCALE_HOST: "maxscale"
      CHECK_INTERVAL: "5"
    volumes:
      - mariadb-primary-data:/var/lib/mysql
      - mariadb-primary-logs:/var/log/mysql
    networks:
      mariadb-net:
        aliases:
          - mariadb-primary
          - Mariadb_mariadb-primary
          - mariadb_mariadb-primary
    secrets:
      - mysql_root_password
      - mysql_user_password
      - replication_password
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.mariadb.node == srv1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  mariadb-secondary:
    image: ghcr.io/chilla55/mariadb-replication:${VERSION:-latest}
    hostname: mariadb-secondary
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: ${MYSQL_DATABASE:-app_db}
      MYSQL_USER: ${MYSQL_USER:-app_user}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_user_password
      REPLICATION_MODE: "slave"
      REPLICATION_USER: "replicator"
      REPLICATION_PASSWORD_FILE: /run/secrets/replication_password
      MASTER_HOST: "mariadb-primary"
      MASTER_PORT: "3306"
      ENABLE_CONNECTIVITY_MONITOR: "true"
      PRIMARY_HOST: "mariadb-primary"
      MAXSCALE_HOST: "maxscale"
      CHECK_INTERVAL: "5"
    volumes:
      - mariadb-secondary-data:/var/lib/mysql
      - mariadb-secondary-logs:/var/log/mysql
    networks:
      mariadb-net:
        aliases:
          - mariadb-secondary
          - Mariadb_mariadb-secondary
          - mariadb_mariadb-secondary
    secrets:
      - mysql_root_password
      - mysql_user_password
      - replication_password
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.mariadb.node == mail
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    depends_on:
      - mariadb-primary

  maxscale:
    image: mariadb/maxscale:latest
    hostname: maxscale-node
    command: >-
      sh -c "apt-get update && apt-get install -y procps && exec /usr/bin/maxscale -d"
    environment:
      MAXSCALE_USER: ${MAXSCALE_USER:-admin}
      MAXSCALE_PASSWORD_FILE: /run/secrets/maxscale_password
    volumes:
      - maxscale-data:/var/lib/maxscale
    configs:
      - source: maxscale_config
        target: /etc/maxscale.cnf
        mode: 0444
    networks:
      mariadb-net:
        aliases:
          - maxscale
          - Mariadb_maxscale
          - mariadb_maxscale
    secrets:
      - maxscale_password
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.mariadb.node == srv2
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M
    depends_on:
      - mariadb-primary
      - mariadb-secondary

volumes:
  mariadb-primary-data:
    driver: local
  mariadb-primary-logs:
    driver: local
  mariadb-secondary-data:
    driver: local
  mariadb-secondary-logs:
    driver: local
  maxscale-data:
    driver: local

networks:
  mariadb-net:
    external: true

secrets:
  mysql_root_password:
    external: true
  mysql_user_password:
    external: true
  replication_password:
    external: true
  maxscale_password:
    external: true

configs:
  maxscale_config:
    file: ./maxscale.cnf
